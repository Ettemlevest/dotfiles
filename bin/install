#!/usr/bin/env zsh
set -euo pipefail

trap 'error "Error on line $LINENO"; exit 1' ERR

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { printf "${BLUE}==>${NC} %s\n" "$1"; }
success() { printf "${GREEN}==>${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}==>${NC} %s\n" "$1"; }
error() { printf "${RED}==>${NC} %s\n" "$1" >&2; }

DOTFILES_DIR="$HOME/.dotfiles"

if [[ ! -d "$DOTFILES_DIR" ]]; then
    error "Dotfiles directory not found: $DOTFILES_DIR"
    exit 1
fi

echo ""
echo "=========================================="
echo "  Dotfiles Installation Script"
echo "=========================================="
echo ""

# ============================================
# Homebrew
# ============================================
log "Checking Homebrew..."
if ! command -v brew &> /dev/null; then
    log "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# ============================================
# Install packages from Brewfile
# ============================================
log "Installing Homebrew packages from Brewfile..."
brew bundle --file="$DOTFILES_DIR/config/Brewfile"

# ============================================
# Symlinks
# ============================================
log "Creating symlinks..."

# Backup existing files
backup_if_exists() {
    if [[ -f "$1" && ! -L "$1" ]]; then
        warn "Backing up existing $1 to $1.backup"
        mv "$1" "$1.backup"
    fi
}

# Shell files
backup_if_exists "$HOME/.zshrc"
ln -sf "$DOTFILES_DIR/shell/zshrc" "$HOME/.zshrc"
success "Linked .zshrc"

# Git config
backup_if_exists "$HOME/.gitconfig"
ln -sf "$DOTFILES_DIR/git/.gitconfig" "$HOME/.gitconfig"
success "Linked .gitconfig"

# ============================================
# FZF Installation (key bindings)
# ============================================
if command -v fzf &> /dev/null; then
    log "Setting up FZF key bindings..."
    "$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
fi

# ============================================
# QuickLook plugins
# ============================================
log "Resetting QuickLook plugins..."
qlmanage -r &>/dev/null || true
qlmanage -r cache &>/dev/null || true

# ============================================
# Tool info
# ============================================
echo ""
success "Installation complete!"
echo ""
log "What's new:"
echo "  - Agnoster theme (requires Nerd Font in terminal)"
echo "  - zoxide: Smart 'cd' - type 'z <partial-path>' to jump"
echo "  - delta: Beautiful git diffs with syntax highlighting"
echo "  - direnv: Per-directory environment variables"
echo "  - bat: Syntax-highlighted 'cat'"
echo "  - QuickLook plugins for code, JSON, Markdown"
echo ""
log "New commands:"
echo "  z <path>     - Smart directory jump (learns your habits)"
echo "  db list      - List MySQL databases"
echo "  db create X  - Create database X"
echo "  t            - Run tests (Pest or PHPUnit)"
echo "  repo         - Open current git repo in browser"
echo "  fshow        - FZF git commit browser"
echo "  h            - Fuzzy history search"
echo ""
log "Next steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. Configure your terminal to use a Nerd Font"
echo "     (e.g., Hack Nerd Font, already installed)"
echo ""
